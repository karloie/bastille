---
networks:
  testing:
    driver: bridge
    ipam:
      config:
        - gateway: 172.16.4.1
          subnet: 172.16.4.0/24

volumes:
  go-build:

services:
  bastille:
    build:
      context: ../
      dockerfile: ./test/Dockerfile
    command: bash -c 'gow run .'
    environment:
      #      LOGLEVEL: VERBOSE
      CIPHERS: | # remove sus ciphers
        -chacha20-poly1305@openssh.com
      HOSTKEYALGORITHMS: | # remove sus host key algorithm
        -rsa-sha2-256
      KEXALGORITHMS: | # remove sus kex algorithm
        -diffie-hellman-group16-sha512
        diffie-hellman-group14-sha256
      MACS: | # remove sus mac algorithm
        -hmac-sha2-256-etm@openssh.com
      SMTP_HOST: smtp.gmail.com
      SMTP_USER: karloie@gmail.com
      TESTING: yes
      STRICTMODES: yes
      MODULI_MIN: '4096'
    hostname: bastille
    networks:
      testing:
        ipv4_address: 172.16.4.10
    ports:
      - 22222:22222/tcp
    volumes:
      - ../:/app:rw
      - go-build:/root/.cache/go-build:rw
      - ./ca:/ca:rw
      - ./home:/home:rw
      - ./hostkeys:/hostkeys:rw
      - ./smtp_pass:/run/secrets/smtp_pass:ro

  target1:
    build: target1
    attach: false
    depends_on:
      - bastille
    networks:
      testing:
        ipv4_address: 172.16.4.12

  target2:
    build: target2
    attach: false
    depends_on:
      - target1
    networks:
      testing:
        ipv4_address: 172.16.4.13
